<!-- File: app/workspace/templates/view_workspace.html -->
{% extends "main_template.html" %}
{% block title %}Workspace: {{ workspace.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Workspace Header -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h2 class="mb-0 d-inline-block me-2">{{ workspace.name }}</h2>
      {% if workspace.is_private %}
        <span class="badge bg-secondary align-middle">Private</span>
      {% else %}
        <span class="badge bg-info text-dark align-middle">Public</span>
      {% endif %}
    </div>
    <div>
      {% if can_edit %}
        <a href="{{ url_for('workspace_bp.edit_workspace', workspace_id=workspace.workspace_id) }}" class="btn btn-outline-secondary me-2">
          <i class="bi bi-pencil-square"></i> Edit Workspace
        </a>
      {% endif %}
      {% if can_manage_members %}
        <!--button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
          <i class="bi bi-person-plus"></i> Invite Member
        </button-->
      {% endif %}
    </div>
  </div>

  {% if workspace.description %}
    <p class="text-muted">{{ workspace.description }}</p>
  {% endif %}

  <hr>

  {# --- UPDATED: Members List Section --- #}
  <div class="card shadow-sm mb-4"> {# Added card wrapper #}
    <div class="card-header d-flex justify-content-between align-items-center"> {# Added card-header #}
      <H4>Members ({{ active_member_count }})</h4> {# Moved title inside header #}
      {# --- Moved Invite Member Button inside header --- #}
      {% if can_manage_members %}
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal"> {# Made button small #}
          <i class="bi bi-person-plus"></i> Invite Member
        </button>
      {% endif %}
    </div>
    <div class="card-body p-0"> {# Added card-body with no padding #}
      <ul class="list-group list-group-flush"> {# Changed to list-group-flush #}
        {% for member in active_members %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <a href="{{ url_for('workspace_bp.member_profile', user_id=member.user_id) }}" class="text-decoration-none">
                 {{ member.user.first_name or '' }} {{ member.user.last_name or '' }} ({{ member.user.email }})
              </a>
              <small class="ms-2 text-muted">Role: {{ member.role | capitalize }}</small>
              {% if member.user_id == workspace.owner_id %}
                <span class="badge bg-warning text-dark ms-1">Owner</span>
              {% endif %}
            </div>
            <div>
              {# --- Member action buttons --- #}
              {% if can_manage_members and member.user_id != current_user.user_id and member.user_id != workspace.owner_id %}
                {# --- Change Role Form --- #}
                <form action="{{ url_for('workspace_bp.change_role', workspace_id=workspace.workspace_id, member_id=member.id) }}" method="POST" class="d-inline-block me-1">
                    <select name="new_role" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                        <option value="member" {% if member.role == 'member' %}selected{% endif %}>Member</option>
                        <option value="manager" {% if member.role == 'manager' %}selected{% endif %}>Manager</option>
                        {# Only Owner can assign Admin role #}
                        {% if current_user.user_id == workspace.owner_id %}
                        <option value="admin" {% if member.role == 'admin' %}selected{% endif %}>Admin</option>
                        {% endif %}
                    </select>
                    {# Hidden submit button for accessibility or if JS fails #}
                    <button type="submit" class="btn btn-sm btn-outline-secondary d-none">Change Role</button>
                </form>

                {# --- Remove Member Form --- #}
                <form action="{{ url_for('workspace_bp.remove_member', workspace_id=workspace.workspace_id, member_id=member.id) }}" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to remove {{ member.user.email }} from this workspace?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove Member">
                    <i class="bi bi-person-x"></i>
                  </button>
                </form>
              {% endif %}
            </div>
          </li>
        {% else %}
          <li class="list-group-item text-muted">No active members found.</li>
        {% endfor %}

        {# --- Pending/Invited Members --- #}
        {% if pending_members %}
           <li class="list-group-item list-group-item-secondary mt-3">Pending / Invited</li>
           {% for member in pending_members %}
             <li class="list-group-item d-flex justify-content-between align-items-center">
               <div>
                 {{ member.user.first_name or '' }} {{ member.user.last_name or '' }} ({{ member.user.email }})
                 <small class="ms-2 text-warning">({{ member.status | capitalize }})</small>
               </div>
               <div>
                 {# --- Approve/Reject Buttons --- #}
                 {% if can_manage_members %}
                    {# --- Approve Form --- #}
                    <form action="{{ url_for('workspace_bp.approve_member', workspace_id=workspace.workspace_id, member_id=member.id) }}" method="POST" class="d-inline-block me-1">
                        <button type="submit" class="btn btn-sm btn-success" title="Approve">
                            <i class="bi bi-check-lg"></i> Approve
                        </button>
                    </form>
                    {# --- Reject Form --- #}
                    <form action="{{ url_for('workspace_bp.reject_member', workspace_id=workspace.workspace_id, member_id=member.id) }}" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to reject the request/invitation for {{ member.user.email }}?');">
                        <button type="submit" class="btn btn-sm btn-danger" title="Reject">
                            <i class="bi bi-x-lg"></i> Reject
                        </button>
                    </form>
                 {% endif %}
               </div>
             </li>
           {% endfor %}
        {% endif %}
      </ul>
    </div> {# End card-body #}
  </div> {# End card #}
  {# --- End Members Section --- #}


  {# --- UPDATED: Workspace Documents section --- #}
  <div class="card shadow-sm mb-4"> {# Added card wrapper #}
      <div class="card-header d-flex justify-content-between align-items-center"> {# Added card-header #}
          {# Updated title to include count, similar to workshops #}
          <h4>Documents ({{ documents | length }})</h4>
          {# --- Button to upload document --- #}
          {# Optional: Add a condition like {% if can_upload_document %} if needed #}
          <a href="{{ url_for('document_bp.upload_document', workspace_id=workspace.workspace_id) }}" class="btn btn-sm btn-primary">
              <i class="bi bi-upload"></i> Upload Document
          </a>
          {# End Optional condition #}
      </div>
      {# Use card-body and remove padding for the list group #}
      <div class="card-body p-0">
          <div class="list-group list-group-flush"> {# Use list-group-flush inside card #}
            {% if documents %}
              {% for doc in documents %}
                <a href="{{ url_for('document_bp.preview_document', document_id=doc.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ doc.title }}</strong>
                    {% if doc.description %}
                      <small class="d-block text-muted">{{ doc.description | striptags | truncate(80) }}</small>
                    {% endif %}
                    <small class="text-muted">Uploaded by: {{ doc.uploader.first_name or doc.uploader.email }} on {{ doc.uploaded_at.strftime('%Y-%m-%d') }}</small>
                  </div>
                  <span class="badge bg-primary rounded-pill">{{ doc.file_size | filesizeformat if doc.file_size is not none else 'N/A' }}</span>
                </a>
              {% endfor %}
            {% else %}
              <div class="list-group-item">
                <p class="text-muted mb-0">No documents have been uploaded to this workspace yet.</p>
              </div>
            {% endif %}
          </div>
      </div>
  </div>
  {# --- End Documents Section --- #}




  {# --- ADDED: Workspace Workshops section --- #}
  <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
          <h4>Workshops ({{ workshops | length }})</h4>
          {# --- ADDED: Button to create workshop --- #}
          {% if can_create_workshop %}
          <a href="{{ url_for('workshop_bp.create_workshop_specific', workspace_id=workspace.workspace_id) }}" class="btn btn-sm btn-primary">
              <i class="bi bi-calendar-plus"></i> Create Workshop
          </a>
          {% endif %}
      </div>
      <div class="card-body p-0"> {# Remove padding for list group #}
          {% if workshops %}
          <ul class="list-group list-group-flush">
              {% for ws in workshops %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                      <strong>{{ ws.title }}</strong><br>
                      <small class="text-muted">
                          Date: {{ ws.date_time.strftime('%Y-%m-%d %H:%M') if ws.date_time else 'N/A' }} |
                          Status: <span class="badge
                              {% if ws.status == 'scheduled' %} bg-info text-dark
                              {% elif ws.status == 'inprogress' %} bg-success
                              {% elif ws.status == 'paused' %} bg-warning text-dark
                              {% elif ws.status == 'completed' %} bg-secondary
                              {% elif ws.status == 'cancelled' %} bg-danger
                              {% else %} bg-light text-dark {% endif %}">
                              {{ ws.status | capitalize }}
                          </span> |
                          Organizer: {{ ws.creator.first_name or ws.creator.email }}
                      </small>
                  </div>
                  <div>
                      <a href="{{ url_for('workshop_bp.view_workshop', workshop_id=ws.id) }}" class="btn btn-sm btn-outline-primary me-1">
                          <i class="bi bi-eye"></i> View
                      </a>
                      {# Edit/Delete only visible to organizer #}
                      {% if ws.created_by_id == current_user.user_id %}
                          <a href="{{ url_for('workshop_bp.edit_workshop', workshop_id=ws.id) }}" class="btn btn-sm btn-outline-secondary me-1">
                              <i class="bi bi-pencil"></i> Edit
                          </a>
                          <form action="{{ url_for('workshop_bp.delete_workshop', workshop_id=ws.id) }}" method="POST" style="display: inline;"
                                onsubmit="return confirm('Are you sure you want to delete this workshop?');">
                              <button type="submit" class="btn btn-sm btn-outline-danger">
                                  <i class="bi bi-trash"></i> Delete
                              </button>
                          </form>
                      {% endif %}
                  </div>
              </li>
              {% endfor %}
          </ul>
          {% else %}
          <p class="text-center text-muted p-3">No workshops scheduled for this workspace yet.</p>
          {% endif %}
      </div>
  </div>
  {# --- End Workshops Section --- #}





</div>{# End container #}

<!-- Invite Member Modal -->
{# --- Use my_membership from route --- #}
{% if my_membership and my_membership.role in ["admin", "manager"] %}
<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="{{ url_for('workspace_bp.invite_member') }}" method="POST" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inviteModalLabel">Send Email Invitation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="workspace_id" value="{{ workspace.workspace_id }}">
        <div class="mb-3">
          <label for="inviteEmail" class="form-label">Recipient Email</label>
          <input type="email" class="form-control" id="inviteEmail" name="email" placeholder="user@example.com" required>
        </div>
        <div class="mb-3">
          <label for="inviteMessage" class="form-label">Custom Message (Optional)</label>
          <textarea class="form-control" id="inviteMessage" name="custom_message" rows="3" placeholder="Write a short message..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Send Invitation</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
  {# Ensure Flatpickr CSS/JS are loaded if not already in base.html #}
  {# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"> #}
  {# <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script> #}
  {{ super() }} {# Include scripts from base template #}
  {# Add Markdown library if not already included #}
  {# <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> #}
  <script>
    // Initialize Flatpickr if needed specifically here (though better in create/edit templates)
    // flatpickr(".flatpickr-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });

    // Initialize Markdown rendering for agenda if needed dynamically
    // document.addEventListener('DOMContentLoaded', function() { ... });
  </script>
{% endblock %}

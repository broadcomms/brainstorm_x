<!-- Display list of Agenda titles from JSON -->
<ol id="agenda-titles-list" class="list-group list-group-numbered mt-2">
  {% if workshop.agenda %}
    {% set agenda_data = workshop.agenda | tojson | safe %}
    {% set agenda_items = agenda_data.agenda if agenda_data.agenda else [] %}
    {% for item in agenda_items %}
      <li class="list-group-item">{{ item.activity }}</li>
    {% endfor %}
  {% else %}
    <p class="text-muted">No agenda available.</p>
  {% endif %}
</ol>

{# Add controls for organizer #}
{% if user_is_organizer %}
<div class="mt-1 text-end"> {# Use text-end for alignment #}
<button class="btn btn-sm btn-outline-primary me-1 regenerate-btn" data-type="agenda" title="Regenerate Agenda">
  <i class="bi bi-arrow-clockwise"></i> <span class="d-none d-md-inline">Regenerate</span>
</button>
{# Link to the main edit page for simplicity in this view #}
<a href="{{ url_for('workshop_bp.edit_workshop', workshop_id=workshop.id) }}" class="btn btn-sm btn-outline-secondary" title="Edit Agenda">
  <i class="bi bi-pencil-square"></i> <span class="d-none d-md-inline">Edit</span>
</a>
</div>
{% endif %}

<script>
  // EXTRACT TITLE FROM JSON AND UPDATE UI
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Pull in the raw JSON string from the Jinja context
    const raw = {{ workshop.agenda | tojson }};
    // Extract JSON substring between first and last braces
    const firstBrace = raw.indexOf('{');
    const lastBrace = raw.lastIndexOf('}');
    const jsonString = (firstBrace !== -1 && lastBrace > firstBrace)
      ? raw.substring(firstBrace, lastBrace + 1)
      : raw;

    let data = {};
    try {
      data = JSON.parse(jsonString);
    } catch (e) {
      console.error('Failed to parse agenda JSON:', e, '\nExtracted JSON:', jsonString, '\nRaw data:', raw);
      return;
    }

    // 2. Extract the activity title from the array
    const items = Array.isArray(data.agenda) ? data.agenda : [];

    // 3. Render each title into the container
    const container = document.getElementById('agenda-titles-list');
    container.innerHTML = '';  // clear any old content
    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = item.activity; // Display only activity as agenda item from the array
      container.appendChild(li);
    });
  });
</script>